<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processing | Authrim Example</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Processing Authentication</h1>
    </header>

    <!-- Loading State -->
    <div id="loading" class="card">
      <div class="status status-loading">
        <span class="spinner"></span> Processing authentication...
      </div>
    </div>

    <!-- Success State -->
    <div id="success" class="card hidden">
      <div class="status status-success">
        Authentication complete. Redirecting...
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="card hidden">
      <div class="status status-error" id="error-message"></div>
      <a href="login.html" class="btn btn-primary">Back to Login</a>
      <a href="index.html" class="btn btn-secondary" style="margin-top: 0.5rem;">Back to Home</a>
    </div>

    <footer>
      <p>Powered by <a href="https://authrim.com" target="_blank">Authrim</a></p>
    </footer>
  </div>

  <!-- Load SDK -->
  <script src="https://unpkg.com/@authrim/web@latest/dist/authrim-web.umd.global.js"></script>
  <script src="config.js"></script>
  <script>
    // Elements
    var $loading = document.getElementById('loading');
    var $success = document.getElementById('success');
    var $error = document.getElementById('error');
    var $errorMessage = document.getElementById('error-message');

    // Show state
    function showState(state) {
      $loading.classList.add('hidden');
      $success.classList.add('hidden');
      $error.classList.add('hidden');

      switch (state) {
        case 'loading':
          $loading.classList.remove('hidden');
          break;
        case 'success':
          $success.classList.remove('hidden');
          break;
        case 'error':
          $error.classList.remove('hidden');
          break;
      }
    }

    // Show error
    function showError(message) {
      $errorMessage.textContent = message;
      showState('error');
    }

    function handlePopupCallbacks() {
      // OAuth popup callback (uses window.name)
      if (
        window.AuthrimWeb &&
        typeof window.name === 'string' &&
        window.name.indexOf('authrim:popup:') === 0 &&
        typeof AuthrimWeb.handlePopupCallback === 'function'
      ) {
        AuthrimWeb.handlePopupCallback();
        return true;
      }

      // Direct Auth social popup callback
      if (window.opener && window.opener.postMessage) {
        var params = new URLSearchParams(window.location.search);
        window.opener.postMessage(
          {
            type: 'authrim:social:callback',
            code: params.get('code') || undefined,
            state: params.get('state') || undefined,
            error: params.get('error') || undefined,
            error_description: params.get('error_description') || undefined,
          },
          window.location.origin
        );
        window.close();
        return true;
      }

      return false;
    }

    // Main
    async function main() {
      try {
        if (handlePopupCallbacks()) {
          return;
        }

        // Check configuration
        if (!window.AUTHRIM_CONFIG?.issuer || window.AUTHRIM_CONFIG.issuer === 'https://your-tenant.authrim.com') {
          showError('Please configure issuer and clientId in config.js');
          return;
        }

        // Initialize SDK with OAuth enabled
        var auth = await AuthrimWeb.createAuthrim({
          issuer: window.AUTHRIM_CONFIG.issuer,
          clientId: window.AUTHRIM_CONFIG.clientId,
          enableOAuth: true,
        });

        // Initialize diagnostic logger if enabled
        var diagConfig = window.AUTHRIM_CONFIG?.diagnostic;
        if (diagConfig?.enabled && AuthrimWeb.createDiagnosticLogger) {
          var diagnosticLogger = AuthrimWeb.createDiagnosticLogger({
            enabled: true,
            collectLogs: diagConfig.collectLogs !== false,
            persistToStorage: diagConfig.persistToStorage !== false,
            maxLogs: diagConfig.maxLogs ?? 1000,
            sendToServer: diagConfig.sendToServer ?? false,
            serverUrl: diagConfig.serverUrl ?? window.AUTHRIM_CONFIG.issuer,
            clientId: window.AUTHRIM_CONFIG.clientId,
          });

          if (diagnosticLogger) {
            auth.setDiagnosticLogger?.(diagnosticLogger);
            window.AUTHRIM_DIAGNOSTIC_LOGGER = diagnosticLogger;
          }
        }

        // First, try to handle as Silent Login callback
        // This checks if the state parameter indicates a silent login flow
        var silentResult = await auth.oauth.handleSilentCallback();

        if (silentResult.status !== 'error' || silentResult.error !== 'not_silent_login') {
          // This was a silent login callback - it handles its own redirects
          // If we reach here, something unexpected happened
          if (silentResult.status === 'error') {
            showError('SSO Error: ' + silentResult.error + (silentResult.errorDescription ? ' - ' + silentResult.errorDescription : ''));
          }
          return;
        }

        var oauthFlow = sessionStorage.getItem('oauth_flow') === '1';

        if (oauthFlow) {
          sessionStorage.removeItem('oauth_flow');
          var oauthResult = await auth.oauth.handleCallback(window.location.href);
          if (oauthResult.error) {
            showError(oauthResult.error.message);
            return;
          }

          showState('success');
          setTimeout(function() {
            window.location.href = 'index.html';
          }, 1000);
          return;
        }

        // Not a silent login callback - handle as regular social login callback
        if (!auth.social.hasCallbackParams()) {
          // No callback parameters, redirect to home
          window.location.href = 'index.html';
          return;
        }

        // Handle regular social login callback
        var result = await auth.social.handleCallback();

        if (result.error) {
          showError(result.error.message);
          return;
        }

        // Success
        showState('success');
        setTimeout(function() {
          window.location.href = 'index.html';
        }, 1000);

      } catch (e) {
        console.error('Callback error:', e);
        showError('Authentication processing failed: ' + e.message);
      }
    }

    main();
  </script>
</body>
</html>
